<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Radio Player - HEART LOVE FM (Espectro Neón)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* --- FUENTES Y COLORES BASE (Dark Mode, Neón) --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
        
        :root {
            --color-neon-accent: #ff007f; /* Rosa Neón (Romance) para acentos */
            --main-bg-fallback: #121212; 
            --text-light: #ffffff;
            --text-faded: #a0a0a0;
        }

        /* --- ESTILOS BASE Y CENTRADO --- */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--main-bg-fallback);
            color: var(--text-light);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            overflow-x: hidden; 
            position: relative;
        }

        /* --- FONDO DE IMAGEN BORROSA --- */
        #background-blur {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(50px) brightness(0.7); 
            transform: scale(1.1); 
            z-index: -1; 
            transition: background-image 0.5s ease-in-out;
        }

        /* --- CONTENEDOR PRINCIPAL (RESPONSIVE) --- */
        #player-container {
            width: 90%;
            max-width: 600px; 
            padding: 30px 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1; 
            border-radius: 15px;
            background-color: rgba(0, 0, 0, 0.4); 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }
        
        /* --- BLOQUE VISUAL (Carátula y Espectro) - CORRECCIÓN ANTI-OVALADO --- */
        #visual-block {
            position: relative;
            /* El tamaño base ahora es fijo para PC */
            width: 400px; 
            height: 400px; 
            
            /* Usamos vmin para asegurar que no se desborde ni se deforme en modo escritorio de móvil */
            max-width: 80vmin; 
            max-height: 80vmin; 
            
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- ESPECTRO CANVAS (Barras Circulares) --- */
        #audio-visualizer-canvas {
            position: absolute;
            top: 0; 
            left: 0;
            /* El canvas debe ser cuadrado para que el espectro circular funcione */
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1; 
        }

        /* --- CARÁTULA REDONDA Y CENTRAL --- */
        #caratula-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%; 
            height: 70%; 
            overflow: hidden;
            border-radius: 50%; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); 
            background-color: #000;
            z-index: 2; 
        }
        #caratula-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- INFO DE LA CANCIÓN --- */
        #text-info {
            text-align: center;
            width: 100%;
            margin-bottom: 25px;
        }
        #online-text {
            color: var(--text-light); 
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        #artista-display {
            font-size: 16px; 
            color: var(--text-faded);
            margin-bottom: 5px;
        }
        #cancion-display {
            font-size: 24px; 
            font-weight: 700;
            color: var(--text-light);
            line-height: 1.2;
            word-wrap: break-word;
        }
        
        /* --- CONTROLES Y VOLUMEN --- */
        #controles-volumen {
            display: flex;
            align-items: center;
            justify-content: center; 
            width: 100%;
            max-width: 450px;
            margin-bottom: 30px;
            position: relative;
            min-height: 80px; 
        }
        
        #btn-play-pause-container {
            position: relative;
            z-index: 3; 
        }

        /* --- BOTÓN PRINCIPAL --- */
        #btn-play-pause {
            background-color: var(--color-neon-accent);
            color: #fff;
            border: 4px solid #fff; 
            width: 70px; 
            height: 70px;
            border-radius: 50%; 
            cursor: pointer;
            font-size: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px var(--color-neon-accent), 0 0 30px rgba(255, 255, 255, 0.5) inset;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.5s ease-in-out;
            margin: 0 20px; 
        }
        #btn-play-pause:hover {
            transform: scale(1.05);
            background-color: #ff3399;
        }
        #play-pause-icon {
            font-size: 30px; 
            margin-left: 3px;
        }

        /* --- VOLUMEN CONTENEDORES --- */
        .volumen-container {
            display: flex;
            align-items: center;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2; 
        }
        #volumen-izq {
            left: 0;
            margin-left: 0;
        }
        #volumen-der {
            right: 0;
            margin-right: 0;
        }

        /* Slider Horizontal */
        #volumen-slider { 
            width: 100px; 
            height: 6px;
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 3px;
            cursor: pointer;
            -webkit-appearance: none;
            margin: 0 5px;
            box-sizing: content-box; 
        }
        
        /* Slider Thumb */
        #volumen-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-neon-accent);
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 8px rgba(255, 0, 127, 0.8);
        }

        #volumen-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-neon-accent);
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 8px rgba(255, 0, 127, 0.8);
        }

        /* --- ÁREA DE LETRAS (CC SIMULADO) --- */
        #lyrics-section {
            width: 100%;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        #lyrics-title {
            font-size: 20px;
            color: var(--color-neon-accent); 
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 0 8px rgba(255, 0, 127, 0.7);
        }
        
        /* --- BOTÓN DE TOGGLE DE LYRICS --- */
        #btn-toggle-lyrics {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin-bottom: 15px;
            display: inline-flex;
            align-items: center;
        }
        #btn-toggle-lyrics:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        #btn-toggle-lyrics i {
            margin-left: 10px;
            transition: transform 0.3s;
        }
        #lyrics-section.open #btn-toggle-lyrics i {
            transform: rotate(180deg);
        }

        /* --- CONTENEDOR DE LYRICS (OCULTABLE) --- */
        #lyrics-content-wrapper {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s;
            opacity: 0;
            width: 100%;
        }

        /* ESTADO ABIERTO */
        #lyrics-section.open #lyrics-content-wrapper {
            max-height: 500px; 
            opacity: 1;
        }

        /* Área de visualización de letras */
        #lyrics-area {
            list-style: none; 
            padding: 10px 15px; 
            margin: 0;
            height: 200px; 
            overflow: hidden; 
            background-color: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2); 
            text-align: center;
            transition: transform 0.3s ease-out; /* Para el efecto de scroll */
        }
        
        /* Estilos de línea de letra */
        .lyric-line {
            padding: 5px 0;
            transition: all 0.3s ease-out;
            color: var(--text-faded);
            font-size: 16px;
        }

        .lyric-line.active {
            color: var(--color-neon-accent);
            font-weight: 700;
            font-size: 18px;
            text-shadow: 0 0 5px rgba(255, 0, 127, 0.7);
        }
        
        /* Estilo para las líneas que se desvanecen (por encima de la vista) */
        .lyric-line.fade-out {
            opacity: 0.6;
            transform: scale(0.95);
        }

        /* Media Query para pantallas grandes (PC, TV) */
        @media (min-width: 800px) {
            #player-container {
                max-width: 700px; /* Mayor espacio horizontal */
            }
            #cancion-display {
                font-size: 32px;
            }
            .volumen-container {
                 width: 180px; 
            }
            #volumen-slider {
                width: 150px;
            }
            #lyrics-area {
                height: 260px; 
            }
        }
        
        /* Media Query para móvil vertical (9:16) */
        @media (max-width: 600px) {
            #player-container {
                padding: 20px 10px;
            }
            /* En móvil, usamos vw para que ocupe casi todo el ancho disponible */
            #visual-block {
                width: 90vw;
                height: 90vw;
                max-width: 350px;
                max-height: 350px;
            }
            #cancion-display {
                font-size: 20px;
            }
            /* Ocultamos el slider de volumen lateral para dar más espacio a los botones */
            .volumen-container {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div id="background-blur"></div>

    <div id="player-container">
        
        <div id="visual-block">
            <canvas id="audio-visualizer-canvas" width="400" height="400"></canvas>
            
            <div id="caratula-container">
                <img id="caratula-img" src="https://zeno.fm/_ipx/_/https://images.zeno.fm/LGol9lXeVJlVfO1bhAvAiJ7s3yl7nAUcaVsaDi1u-hw/rs:fill:288:288/g:ce:0:0/aHR0cHM6Ly9wcm94eS56ZW5vLmZtL2NvbnRlbnQvc3RhdGlvbnMvMTllOWM2NDktODNmZS00ZDA1LWEwNGYtY2Y5NThiNDEzMTlhL2ltYWdlLz91PTE3MzE5ODYxMzgwMDA.webp" alt="Logo de Heart Love FM" />
            </div>
        </div>
        
        <div id="text-info">
            <div id="online-text"></div>
            <div id="artista-display">HEART LOVE FM</div>
            <div id="cancion-display">PRESIONA PLAY PARA COMENZAR</div>
        </div>
        
        <div id="controles-volumen">
            <div id="volumen-izq" class="volumen-container">
                <i id="volume-icon" class="fa-solid fa-volume-low" style="font-size: 18px; color: var(--color-neon-accent); transition: transform 0.3s ease-out;"></i>
                <input type="range" id="volumen-slider" min="0" max="1" step="0.01" value="0.5">
            </div>
            
            <div id="btn-play-pause-container">
                <button id="btn-play-pause">
                    <span id="play-pause-icon"><i class="fa-solid fa-play fa-fade"></i></span>
                </button>
            </div>
            
            <div id="volumen-der" class="volumen-container"></div>
        </div>
        
        <div id="lyrics-section">
            <div id="lyrics-title">LYRICS</div>
            
            <button id="btn-toggle-lyrics">
                Mostrar Lyrics <i class="fa-solid fa-chevron-down"></i>
            </button>
            
            <div id="lyrics-content-wrapper">
                 <ol id="lyrics-area">
                    <li class="lyric-line fade-out">Las letras de la canción aparecerán aquí</li>
                    <li class="lyric-line fade-out">con un efecto de resaltado de línea</li>
                    <li class="lyric-line fade-out">para simular la sincronización (CC).</li>
                    <li class="lyric-line fade-out">Dale Play para iniciar.</li>
                </ol>
            </div>
        </div>

    </div>
    
    <audio id="radio-stream" crossorigin="anonymous" src="https://stream.zeno.fm/cr8evht2huruv"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // *** CONFIGURACIÓN CLAVE ***
            const METADATA_PROXY_URL = 'https://api.zeno.fm/mounts/metadata/subscribe/cr8evht2huruv'; 
            
            const LASTFM_API_KEY = '217df5ef951f0b3813906b25c5cb5448'; 
            const ALBUM_ART_PROXY_URL = 'https://images.weserv.nl/?url='; 
            const LYRICS_API_URL_BASE = 'https://api.lyrics.ovh/'; 
            const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/'; 
            
            // CONFIGURACIÓN DEL ESPECTRO DE BARRAS (Canvas)
            const BAR_COUNT = 128; 
            const CANVAS_SIZE = 350; 
            const CENTER_X = CANVAS_SIZE / 2;
            const CENTER_Y = CANVAS_SIZE / 2;
            const MIN_RADIUS = 125; 
            const MAX_EXTEND_OUT = 60; 
            const MAX_EXTEND_IN = 10; 
            const BAR_WIDTH = 2; 
            const ROTATION_SPEED = 0.0005; 
            
            // PALETA DE COLORES NEÓN TEMÁTICA
            const NEON_COLOR_PALETTE = [
                '255, 0, 127', '255, 255, 0', '255, 102, 0', '127, 0, 255'    
            ];
            let currentSpectrumColor = NEON_COLOR_PALETTE[0]; 
            let currentColorIndex = 0; 
            
            const defaultArt = 'https://zeno.fm/_ipx/_/https://images.zeno.fm/LGol9lXeVJlVfO1bhAvAiJ7s3yl7nAUcaVsaDi1u-hw/rs:fill:288:288/g:ce:0:0/aHR0cHM6Ly9wcm94eS56ZW5vLmZtL2NvbnRlbnQvc3RhdGlvbnMvMTllOWM2NDktODNmZS00ZDA1LWEwNGYtY2Y5NThiNDEzMTlhL2ltYWdlLz91PTE3MzE5ODYxMzgwMDA.webp'; 
            // --------------------------------

            // --- REFERENCIAS DE ELEMENTOS ---
            const radio = document.getElementById('radio-stream');
            const btnPlayPause = document.getElementById('btn-play-pause');
            const playPauseIcon = document.getElementById('play-pause-icon');
            
            const controlVolumen = document.getElementById('volumen-slider'); 
            const volumeIcon = document.getElementById('volume-icon'); 
            
            const onlineText = document.getElementById('online-text');
            const backgroundBlur = document.getElementById('background-blur'); 
            
            const canvas = document.getElementById('audio-visualizer-canvas');
            const ctx = canvas.getContext('2d');
            
            const artistaDisplay = document.getElementById('artista-display');
            const cancionDisplay = document.getElementById('cancion-display');
            const caratulaImg = document.getElementById('caratula-img'); 
            const lyricsArea = document.getElementById('lyrics-area');
            
            const lyricsSection = document.getElementById('lyrics-section'); 
            const btnToggleLyrics = document.getElementById('btn-toggle-lyrics'); 

            let isPlaying = false;
            let eventSource = null; 
            let lastSong = ''; 

            let audioContext = null;
            let analyser = null;
            let source = null;
            let frequencyData = null;
            let animationFrameId = null; 
            
            let rotationAngle = 0; 
            let isRotating = false; 
            
            let audioInitialized = false; 
            
            // --- LÓGICA DE LYRICS CON AUTO-SCROLL/RESALTADO (CC SIMULADO) ---
            let lyricsLines = [];
            let currentLineIndex = 0;
            let lyricsIntervalId = null;
            const LINES_PER_PAGE = 8; 
            let scrollIntervalTime = 0; 
            
            // --- LÓGICA DE TOGGLE ---
            btnToggleLyrics.addEventListener('click', () => {
                const isOpen = lyricsSection.classList.toggle('open');
                const icon = btnToggleLyrics.querySelector('i');
                
                if (isOpen) {
                    btnToggleLyrics.firstChild.textContent = 'Ocultar Lyrics ';
                    if (isPlaying && lyricsLines.length > LINES_PER_PAGE && !lyricsIntervalId) {
                         resumeLyricsAutoScroll(); 
                    }
                } else {
                    btnToggleLyrics.firstChild.textContent = 'Mostrar Lyrics ';
                    if (lyricsIntervalId) {
                         stopLyricsAutoScroll();
                    }
                }
            });

            function stopLyricsAutoScroll() {
                 if (lyricsIntervalId) {
                    clearInterval(lyricsIntervalId);
                    lyricsIntervalId = null;
                 }
                 const linesInView = lyricsArea.querySelectorAll('.lyric-line');
                 if (linesInView.length > 0 && linesInView[0].classList.contains('active')) {
                     linesInView[0].className = 'lyric-line fade-out'; 
                 }
            }


            function renderLyrics() {
                lyricsArea.innerHTML = '';
                const linesToRender = lyricsLines.slice(0, LINES_PER_PAGE); 
                
                linesToRender.forEach((line) => {
                    const li = document.createElement('li');
                    li.className = 'lyric-line fade-out';
                    li.textContent = line;
                    lyricsArea.appendChild(li);
                });

                if (lyricsLines.length === 0) {
                     lyricsArea.innerHTML = '<li class="lyric-line fade-out">Buscando letras...</li>';
                }
            }

            function resetLyricsAutoScroll() {
                stopLyricsAutoScroll(); 
                currentLineIndex = 0;
                scrollIntervalTime = 0;
                
                const lines = lyricsArea.querySelectorAll('.lyric-line');
                lines.forEach(line => line.className = 'lyric-line fade-out');
                lyricsArea.style.transform = 'translateY(0)'; 
            }
            
            function resumeLyricsAutoScroll() {
                if (!lyricsIntervalId && isPlaying && lyricsSection.classList.contains('open') && lyricsLines.length > LINES_PER_PAGE && scrollIntervalTime > 0) {
                    
                    const linesInView = lyricsArea.querySelectorAll('.lyric-line');
                    if (linesInView.length > 0) {
                         linesInView[0].className = 'lyric-line active';
                         for (let i = 1; i < linesInView.length; i++) {
                             linesInView[i].className = 'lyric-line fade-out';
                         }
                    }

                    lyricsIntervalId = setInterval(displayCurrentLyricsSegment, scrollIntervalTime);
                }
            }
            
            function displayCurrentLyricsSegment(isInitialRun = false) {
                const linesInView = lyricsArea.querySelectorAll('.lyric-line');
                if (linesInView.length === 0 && lyricsLines.length > 0) {
                    renderLyrics();
                    return;
                }
                
                if (isInitialRun) {
                    linesInView.forEach((line, index) => {
                        line.className = index === 0 ? 'lyric-line active' : 'lyric-line fade-out';
                    });
                    return;
                }

                const oldActiveLine = linesInView[0];
                const nextActiveLine = linesInView[1];
                
                if (oldActiveLine) {
                    oldActiveLine.className = 'lyric-line fade-out'; 
                    if(nextActiveLine) {
                        nextActiveLine.className = 'lyric-line active';
                    }
                    
                    const lineHeight = oldActiveLine.offsetHeight + parseInt(window.getComputedStyle(oldActiveLine).marginBottom);
                    lyricsArea.style.transform = `translateY(-${lineHeight}px)`;
                } else {
                    startLyricsAutoScroll(lyricsLines.join('\n'));
                    return;
                }

                setTimeout(() => {
                    if (currentLineIndex < lyricsLines.length) {
                        const newLine = document.createElement('li');
                        newLine.className = 'lyric-line fade-out';
                        newLine.textContent = lyricsLines[currentLineIndex];
                        lyricsArea.appendChild(newLine);
                        
                        if (lyricsArea.firstChild) {
                             lyricsArea.removeChild(lyricsArea.firstChild);
                        }
                        lyricsArea.style.transform = 'translateY(0)'; 
                        
                        currentLineIndex++;
                        
                    } else {
                        startLyricsAutoScroll(lyricsLines.join('\n'));
                    }

                }, 350); 
            }

            function startLyricsAutoScroll(lyricsText, isResuming = false) {
                if (isResuming) {
                    resumeLyricsAutoScroll();
                    return;
                }

                if (typeof lyricsText === 'string') {
                   lyricsLines = lyricsText.split('\n').filter(line => line.trim() !== '');
                }
                
                resetLyricsAutoScroll(); 
                
                currentLineIndex = LINES_PER_PAGE; 
                
                if (lyricsLines.length > LINES_PER_PAGE) {
                    
                    renderLyrics(); 
                    
                    const estimatedSongDurationSec = 210; 
                    const scrollCount = Math.ceil(lyricsLines.length / 2); 
                    const dynamicInterval = Math.round(estimatedSongDurationSec / scrollCount) * 1000;
                    const finalInterval = Math.max(3000, Math.min(12000, dynamicInterval)); 
                    scrollIntervalTime = finalInterval; 
                    
                    const INITIAL_DELAY = 5000; 
                    
                    if (isPlaying && lyricsSection.classList.contains('open')) {
                        setTimeout(() => {
                            displayCurrentLyricsSegment(true); 
                            lyricsIntervalId = setInterval(displayCurrentLyricsSegment, scrollIntervalTime);
                        }, INITIAL_DELAY); 
                    }

                } else {
                    lyricsArea.innerHTML = lyricsLines.map(line => `<li class="lyric-line">${line}</li>`).join('');
                }
            }


            // --- FUNCIONES PRINCIPALES DE CONTROL ---
            
            function updateStatus(message) {
                const accentColor = `rgb(${currentSpectrumColor})`;
                
                btnPlayPause.style.boxShadow = `0 0 15px ${accentColor}, 0 0 30px rgba(255, 255, 255, 0.5) inset`;
                btnPlayPause.style.borderColor = `rgb(${currentSpectrumColor.split(',').map(c => Math.min(255, parseInt(c.trim()) + 50)).join(',')})`; 
                
                onlineText.innerHTML = `• <span style="color:${accentColor};">${message.toUpperCase()}</span>`;
                onlineText.style.textShadow = `0 0 8px rgba(${accentColor}, 0.7)`;

                if (message.includes('PAUSA') || message.includes('OFFLINE') || message.includes('MUTE')) {
                    onlineText.innerHTML = `• <span style="color:#888888;">${message.toUpperCase()}</span>`;
                    onlineText.style.textShadow = 'none';
                    btnPlayPause.style.boxShadow = '0 0 10px rgba(255, 0, 127, 0.8)';
                    btnPlayPause.style.borderColor = '#fff';
                }
                if (message.includes('CONECTANDO') || message.includes('Error')) {
                    onlineText.innerHTML = `• <span style="color:orange;">${message.toUpperCase()}</span>`;
                    onlineText.style.textShadow = '0 0 8px rgba(255, 165, 0, 0.7)';
                }
            }
            
            // ** FUNCIÓN initializeAudio() - LIGERA MODIFICACIÓN **
            function initializeAudio() {
                if (audioInitialized) return; 
                
                // Inicialización de AudioContext
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Analizador
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512; 
                analyser.minDecibels = -90;
                analyser.maxDecibels = -10;
                
                // Conexión del grafo de audio
                source = audioContext.createMediaElementSource(radio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                frequencyData = new Uint8Array(analyser.frequencyBinCount);
                audioInitialized = true; // Marcar como inicializado
            }
            
            function drawSpectrum() {
                if (!isPlaying || radio.paused || radio.volume === 0 || !analyser) {
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                    ctx.clearRect(0, 0, canvas.width, canvas.height); 
                    return;
                }

                analyser.getByteFrequencyData(frequencyData);
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                
                ctx.save(); 
                
                if (isRotating) {
                    rotationAngle += ROTATION_SPEED;
                    // Los cálculos usan CANVAS_SIZE (350) para la lógica central
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(rotationAngle);
                    ctx.translate(-canvas.width / 2, -canvas.height / 2);
                }
                
                ctx.shadowColor = `rgba(${currentSpectrumColor}, 0.9)`; 
                ctx.shadowBlur = 18; 
                ctx.lineWidth = BAR_WIDTH; 

                const bufferLength = analyser.frequencyBinCount;
                const dataRange = Math.floor(bufferLength * 0.75); 

                const normalizedAudioValues = [];
                for (let i = 0; i < dataRange; i++) {
                    let v = frequencyData[i] / 255;
                    v = v * v * 0.7 + 0.1; 
                    normalizedAudioValues.push(v);
                }

                const quadrantSize = BAR_COUNT / 4;
                const audioDataHalf = Math.floor(dataRange / 2); 
                
                const currentCenterX = canvas.width / 2;
                const currentCenterY = canvas.height / 2;

                for (let i = 0; i < BAR_COUNT; i++) {
                    let v;
                    let dataIndex;

                    if (i < quadrantSize) { 
                        dataIndex = Math.floor((i / quadrantSize) * audioDataHalf);
                    } else if (i < 2 * quadrantSize) { 
                        dataIndex = Math.floor(((2 * quadrantSize - 1 - i) / quadrantSize) * audioDataHalf);
                    } else if (i < 3 * quadrantSize) { 
                        dataIndex = Math.floor(((i - 2 * quadrantSize) / quadrantSize) * audioDataHalf);
                    } else { 
                        dataIndex = Math.floor(((4 * quadrantSize - 1 - i) / quadrantSize) * audioDataHalf);
                    }
                    
                    dataIndex = Math.min(dataIndex, normalizedAudioValues.length - 1);
                    v = normalizedAudioValues[dataIndex];

                    let extendOut = v * MAX_EXTEND_OUT * (canvas.width / CANVAS_SIZE); 
                    let extendIn = v * MAX_EXTEND_IN * (canvas.width / CANVAS_SIZE); 
                    let currentMinRadius = MIN_RADIUS * (canvas.width / CANVAS_SIZE); 

                    const angle = (i / BAR_COUNT) * 2 * Math.PI; 
                    
                    const startX = currentCenterX + (currentMinRadius - extendIn) * Math.cos(angle);
                    const startY = currentCenterY + (currentMinRadius - extendIn) * Math.sin(angle);
                    const endX = currentCenterX + (currentMinRadius + extendOut) * Math.cos(angle);
                    const endY = currentCenterY + (currentMinRadius + extendOut) * Math.sin(angle);

                    ctx.strokeStyle = `rgba(${currentSpectrumColor}, ${0.5 + v * 0.5})`; 
                    
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                }
                
                ctx.restore(); 

                animationFrameId = requestAnimationFrame(drawSpectrum);
            }
            
            function updateIcon(iconState) {
                const iconMap = {
                    'play': 'fa-solid fa-play fa-fade',
                    'pause': 'fa-solid fa-pause fa-fade',
                    'loading': 'fa-solid fa-arrows-rotate fa-fade'
                };
                playPauseIcon.innerHTML = `<i class="${iconMap[iconState]}"></i>`;
            }
            
            // ** FUNCIÓN playRadio() - CORRECCIÓN DEFINITIVA CON ASYNC/AWAIT **
            async function playRadio(attemptCount = 1) {
                if (isPlaying) return; 
                updateStatus('CONECTANDO');
                updateIcon('loading'); 
                
                // 1. INICIALIZA EL AUDIO CONTEXT (Solo si es la primera vez)
                initializeAudio(); 
                
                // 2. FORZAR LA REANUDACIÓN DEL CONTEXTO DE AUDIO JUSTO ANTES DE HACER PLAY
                if (audioContext && audioContext.state === 'suspended') {
                    try {
                        await audioContext.resume();
                        console.log("AudioContext reanudado con éxito.");
                    } catch(e) {
                        console.error("Fallo al intentar reanudar AudioContext:", e);
                    }
                }

                // (Lógica de re-carga del stream si es necesario)
                if (attemptCount > 1 || radio.paused) {
                    const currentSrc = radio.getAttribute('src');
                    radio.removeAttribute('src'); 
                    radio.load();
                    radio.setAttribute('src', currentSrc);
                    radio.load();
                }
                
                // 3. LLAMA A play()
                radio.play().then(() => {
                    updateIcon('pause'); 
                    isPlaying = true;
                    updateStatus('ONLINE'); 
                    startSSEListener(); 
                    isRotating = true; 
                    requestAnimationFrame(drawSpectrum); 
                    
                    if (lyricsLines.length > LINES_PER_PAGE && scrollIntervalTime > 0) {
                         resumeLyricsAutoScroll(); 
                    } else if (lastSong && lyricsLines.length === 0) {
                         const currentArtist = artistaDisplay.textContent;
                         const currentSong = cancionDisplay.textContent;
                         fetchLyrics(currentArtist, currentSong);
                    }

                }).catch(error => {
                    console.error(`Error al reproducir el stream (Intento ${attemptCount}):`, error);
                    
                    // Si el error persiste, reintentamos una vez y luego fallamos con una alerta.
                    if (attemptCount === 1) {
                         updateStatus('CONECTANDO (Reintento)');
                         setTimeout(() => playRadio(2), 1000); 
                    } else {
                        updateStatus('OFFLINE (Bloqueo de Audio)');
                        updateIcon('play'); 
                        alert('El navegador de tu TV está bloqueando la reproducción automática. Intenta tocar la pantalla/botón varias veces o busca la opción "Permitir audio" en la configuración de privacidad del navegador de tu TV.');
                    }
                });
            }
            
            function stopRadio() {
                if (!isPlaying) return;
                
                radio.pause();
                
                if (eventSource) eventSource.close(); 
                updateIcon('play'); 
                isPlaying = false;
                updateStatus('PAUSA');
                isRotating = false; 
                drawSpectrum(); 
                
                stopLyricsAutoScroll();
            }

            btnPlayPause.addEventListener('click', () => {
                 if (isPlaying) {
                    stopRadio();
                } else {
                    playRadio(); 
                }
            });
            
            function syncVolume(slider) {
                radio.volume = parseFloat(slider.value);
                const volumePercentage = radio.volume * 100;
                
                const neonColor = `rgb(${currentSpectrumColor})`; 
                const trackBackground = `linear-gradient(to right, ${neonColor} 0%, ${neonColor} ${volumePercentage}%, rgba(255, 255, 255, 0.2) ${volumePercentage}%, rgba(255, 255, 255, 0.2) 100%)`;
                slider.style.background = trackBackground;

                const iconMap = {
                    high: 'fa-volume-high',
                    low: 'fa-volume-low',
                    mute: 'fa-volume-off'
                };
                let iconClass = iconMap.high;

                if (radio.volume === 0) {
                    iconClass = iconMap.mute;
                } else if (radio.volume < 0.5) {
                    iconClass = iconMap.low;
                }
                
                volumeIcon.className = `fa-solid ${iconClass}`;
                volumeIcon.style.color = neonColor;
                
                const maxMovement = 20; 
                let iconShift = 0;
                
                if (radio.volume > 0) {
                    iconShift = (1 - radio.volume) * maxMovement * 0.8;
                }
                volumeIcon.style.transform = `translateX(-${iconShift}px)`;


                if (isPlaying && radio.volume === 0) {
                    updateStatus('MUTE');
                } else if (isPlaying && (onlineText.textContent.includes('MUTE') || onlineText.textContent.includes('PAUSA'))) { 
                    updateStatus('ONLINE'); 
                }
            }
            
            controlVolumen.addEventListener('input', (event) => syncVolume(event.target));
            
            function updateBackground(imageUrl) {
                if (imageUrl && imageUrl !== defaultArt) {
                    backgroundBlur.style.backgroundImage = `url(${imageUrl})`;
                    backgroundBlur.style.transition = 'background-image 1s ease-in-out';
                } else {
                    backgroundBlur.style.backgroundImage = `url(${defaultArt})`; 
                    backgroundBlur.style.transition = 'none';
                }
            }
            
            
            function fetchLyrics(artist, song) { 
                lyricsLines = []; 
                resetLyricsAutoScroll();
                lyricsArea.innerHTML = '<li class="lyric-line fade-out">Buscando letras...</li>';

                if (artist.includes('HEART LOVE') || song.includes('SINTONIZANDO')) {
                     lyricsArea.innerHTML = '<li class="lyric-line fade-out">Las letras aparecerán cuando se identifique la canción.</li>';
                     return;
                }
                const apiPath = `v1/${encodeURIComponent(artist)}/${encodeURIComponent(song)}`;
                const proxiedUrl = CORS_PROXY + LYRICS_API_URL_BASE + apiPath;
                fetch(proxiedUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.lyrics) {
                            startLyricsAutoScroll(data.lyrics);
                        } else {
                            lyricsArea.innerHTML = `<li class="lyric-line fade-out">[NO ENCONTRADO] Letra para: ${song}.</li>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error al buscar letras:', error);
                        lyricsArea.innerHTML = '<li class="lyric-line fade-out">[ERROR] Falló la búsqueda de letras.</li>';
                    });
            }
            
            function fetchAlbumArtFallback(artist) { 
                 const fallbackUrl = `https://ws.audioscrobbler.com/2.0/?method=artist.gettopalbums&api_key=${LASTFM_API_KEY}&artist=${encodeURIComponent(artist)}&limit=1&format=json`;
                 fetch(fallbackUrl) 
                     .then(response => response.json())
                     .then(data => {
                         let imageUrl = defaultArt;
                         const album = data.topalbums?.album?.[0];
                         if (album && album.image) {
                             const largeImage = album.image.find(img => img.size === 'extralarge' || img.size === 'large');
                             if (largeImage && largeImage['#text']) {
                                 imageUrl = ALBUM_ART_PROXY_URL + encodeURIComponent(largeImage['#text']);
                             }
                         }
                         if (!imageUrl || imageUrl.includes('2a96cbd8b46e442fc41c2b86b821562f')) {
                             caratulaImg.src = defaultArt;
                         } else {
                             caratulaImg.src = imageUrl;
                         }
                         updateBackground(imageUrl); 
                     })
                     .catch(error => {
                         console.error('Error en Intento 2 (Artist Top Album):', error);
                         caratulaImg.src = defaultArt; 
                         updateBackground(defaultArt); 
                     });
            }
            
            function fetchAlbumArt(artist, song) { 
                caratulaImg.src = 'https://i.imgur.com/l83Qn0I.gif'; 
                updateBackground(''); 
                
                if (!artist || !song || artist.includes('HEART LOVE') || song.includes('SINTONIZANDO...')) {
                    caratulaImg.src = defaultArt;
                    updateBackground(defaultArt); 
                    return;
                }
                
                const searchUrl = `https://ws.audioscrobbler.com/20/?method=track.search&api_key=${LASTFM_API_KEY}&artist=${encodeURIComponent(artist)}&track=${encodeURIComponent(song)}&format=json`;
                
                fetch(searchUrl)
                    .then(response => response.json())
                    .then(data => {
                        let imageUrl = null;
                        const trackMatches = data.results?.trackmatches?.track;
                        
                        if (trackMatches && trackMatches.length > 0) {
                            const track = Array.isArray(trackMatches) ? trackMatches[0] : trackMatches;
                            const imageArray = track.image;
                            if (imageArray) {
                                const largeImage = imageArray.find(img => img.size === 'extralarge' || img.size === 'large');
                                if (largeImage && largeImage['#text']) {
                                    imageUrl = ALBUM_ART_PROXY_URL + encodeURIComponent(largeImage['#text']); 
                                }
                            }
                        }

                        if (imageUrl && !imageUrl.includes('2a96cbd8b46e442fc41c2b86b821562f')) {
                            caratulaImg.src = imageUrl;
                            updateBackground(imageUrl); 
                        } else {
                            return fetchAlbumArtFallback(artist);
                        }
                    })
                    .catch(error => {
                        console.error('Error en Intento 1 (Track Search):', error);
                        return fetchAlbumArtFallback(artist);
                    });
            }
            
            function startSSEListener() {
                if (eventSource) { eventSource.close(); }
                eventSource = new EventSource(METADATA_PROXY_URL); 
                
                eventSource.onopen = () => {
                    if (isPlaying) {
                        isRotating = true;
                    }
                };

                eventSource.onerror = () => {
                    isRotating = false;
                    console.error('Error en la conexión SSE. Giro detenido.');
                    updateStatus('Error de Datos'); 
                };

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        const streamTitle = data.streamTitle || 'Heart Love FM - Sintonizando...';
                        
                        let artistText = ''; 
                        let songText = ''; 
                        const parts = streamTitle.split(" - ");

                        if (parts.length >= 2) {
                            artistText = parts[0].trim();
                            songText = parts[1].trim();
                        } else {
                            songText = streamTitle.trim();
                            artistText = 'Heart Love FM'; 
                        }
                        
                        function cleanTitle(title) {
                            title = title.replace(/\([^)]+\)/g, '').trim(); 
                            title = title.replace(/\[[^\]]+\]/g, '').trim();
                            title = title.replace(/(\d{4}|REMIX|RADIO EDIT|VERSION|LIVE|UNPLUGGED|FEAT\.|FT\.|MIX|ORIGINAL|RADIO)/gi, '').trim();
                            title = title.replace(/(\d+K|KBPS|HD|ZENOFM)/gi, '').trim(); 
                            title = title.replace(/[-|_]$/g, '').trim(); 
                            title = title.replace(/\s+/g, ' ').trim();
                            return title; 
                        }

                        let searchArtist = cleanTitle(artistText).toUpperCase();
                        let searchSong = cleanTitle(songText).toUpperCase();
                        searchArtist = searchArtist.replace(/,/g, ' & '); 
                        
                        if (searchSong.includes('SINTONIZANDO') || searchSong === '') {
                            searchArtist = 'HEART LOVE FM';
                            searchSong = 'SINTONIZANDO...';
                        }
                        
                        artistaDisplay.textContent = artistText;
                        cancionDisplay.textContent = songText;
                        updateStatus('ONLINE'); 

                        if (searchSong !== lastSong && searchSong !== 'SINTONIZANDO...') {
                            currentColorIndex = (currentColorIndex + 1) % NEON_COLOR_PALETTE.length; 
                            currentSpectrumColor = NEON_COLOR_PALETTE[currentColorIndex]; 
                            
                            rotationAngle = 0; 
                            isRotating = true; 
                            
                            fetchAlbumArt(searchArtist, searchSong); 
                            fetchLyrics(searchArtist, searchSong); 
                            lastSong = searchSong;
                        } else if (searchSong === 'SINTONIZANDO...') {
                            isRotating = false; 
                            lastSong = searchSong;
                        }

                    } catch (e) {
                        console.error('Error al procesar metadatos SSE:', e);
                        isRotating = false; 
                        artistaDisplay.textContent = 'Error de Datos';
                        cancionDisplay.textContent = 'Revisar Consola';
                        updateStatus('Error de Datos'); 
                    }
                };
            }
            
            // Inicialización
            radio.volume = controlVolumen.value;
            syncVolume(controlVolumen); 
            updateStatus('OFFLINE');
            
            // ** OBSERVER PARA EL AJUSTE DE CANVAS (ANTI-OVALADO) **
            const visualBlock = document.getElementById('visual-block');
            const observer = new ResizeObserver(entries => {
                for (let entry of entries) {
                    const width = entry.contentRect.width;
                    const height = entry.contentRect.height;
                    // Asegura que las dimensiones del Canvas sean las del contenedor cuadrado
                    canvas.width = width;
                    canvas.height = height;
                }
            });
            observer.observe(visualBlock);
            
            drawSpectrum();
            updateBackground(defaultArt); 
        });
    </script>
</body>
</html>
